<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget App</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors">
    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <span id="toast-message"></span>
    </div>

    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-600 dark:text-blue-400">Budget App</h1>
            <div class="flex gap-2">
                <button onclick="showImportView()" class="btn-secondary">Import</button>
                <button id="theme-toggle" onclick="toggleTheme()" class="btn-secondary" title="Toggle dark mode">
                    <span id="theme-icon">üåô</span>
                </button>
                <button onclick="showAddTransactionModal()" class="btn-primary">+ Add Transaction</button>
                <button onclick="showAddTransferModal()" class="btn-secondary">Transfer</button>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 py-6 flex gap-6">
        <!-- Left Sidebar - Accounts & Activity -->
        <aside class="w-80 flex-shrink-0">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md dark:shadow-gray-900 sticky top-24 overflow-hidden">
                <!-- Accounts Section -->
                <div class="border-b border-gray-200 dark:border-gray-700">
                    <div class="p-4 bg-gray-50 dark:bg-gray-700/50">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide">Accounts</h3>
                            <button onclick="showAddAccountModal()" class="text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 text-sm font-medium">+ Add</button>
                        </div>
                        <div id="sidebar-accounts-list" class="space-y-2">
                            <!-- Accounts will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Recent Activity Section -->
                <div class="p-4">
                    <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 uppercase tracking-wide mb-3">Recent Activity</h3>

                    <!-- Uncategorized Transactions -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-xs font-medium text-gray-600 dark:text-gray-400 uppercase">Uncategorized <span id="uncategorized-count" class="ml-1"></span></h4>
                        </div>
                        <div id="sidebar-uncategorized-list" class="space-y-2 max-h-64 overflow-y-auto">
                            <!-- Uncategorized transactions will be rendered here -->
                        </div>
                    </div>

                    <!-- Recent Transactions -->
                    <div>
                        <h4 class="text-xs font-medium text-gray-600 dark:text-gray-400 uppercase mb-2">Recent</h4>
                        <div id="sidebar-recent-list" class="space-y-2 max-h-48 overflow-y-auto">
                            <!-- Recent transactions will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content - Budget View Only -->
        <main class="flex-1" id="main-content">
            <!-- Budget View -->
            <div id="budget-view" class="view">
                <div class="card mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Budget - <span id="current-month"></span></h2>
                        <div class="flex gap-2">
                            <button onclick="changeMonth(-1)" class="btn-secondary">‚Üê Previous</button>
                            <button onclick="changeMonth(1)" class="btn-secondary">Next ‚Üí</button>
                        </div>
                    </div>

                    <div id="ready-to-assign-box" class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6 transition-colors">
                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-1">Ready to Assign</div>
                        <div class="flex items-center gap-2">
                            <div class="text-3xl font-bold text-blue-600 dark:text-blue-400" id="ready-to-assign">$0.00</div>
                            <div id="ready-to-assign-checkmark" class="text-3xl hidden">‚úì</div>
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-2" id="ready-to-assign-message">Money available to allocate to categories</div>
                    </div>

                    <div class="mb-4 flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">Categories</h3>
                        <div class="flex gap-2">
                            <button onclick="toggleExpandCollapseAll()" id="expand-collapse-btn" class="btn-secondary text-sm">Expand All</button>
                        </div>
                    </div>

                    <div id="budget-categories" class="space-y-4">
                        <!-- Groups and categories will be loaded here with drag-and-drop -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Transaction Panel Backdrop -->
    <div id="transaction-panel-backdrop" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 hidden" onclick="closeTransactionPanel()"></div>

    <!-- Transaction Panel (Slides in from right) -->
    <div id="transaction-panel" class="fixed top-0 right-0 h-full w-full md:w-2/3 lg:w-1/2 bg-white dark:bg-gray-800 shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto">
        <div class="sticky top-0 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4 flex justify-between items-center z-10">
            <div>
                <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100" id="transaction-panel-title">Transactions</h2>
                <p class="text-sm text-gray-600 dark:text-gray-400" id="transaction-panel-subtitle"></p>
            </div>
            <button onclick="closeTransactionPanel()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl font-bold">&times;</button>
        </div>

        <div id="transaction-panel-content" class="p-4">
            <!-- Transactions will be loaded here -->
        </div>
    </div>

    <!-- Import Modal/View -->
    <div id="import-modal" class="modal" onclick="if(event.target === this) closeImportView()">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Import Transactions</h2>
                <button onclick="closeImportView()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl font-bold">&times;</button>
            </div>

            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">Import from OFX/QFX File</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Upload a transaction file exported from your bank or credit card company. Supported formats: .ofx, .qfx</p>

                <form id="import-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Account *</label>
                        <select id="import-account" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            <option value="">Choose account to import into...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select File *</label>
                        <input type="file" id="import-file" accept=".ofx,.qfx" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Maximum file size: 10MB</p>
                    </div>

                    <button type="submit" class="btn-primary">Import Transactions</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div id="transaction-modal" class="modal" onclick="if(event.target === this) closeModal('transaction-modal')">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4 dark:text-gray-100">Add Transaction</h3>
            <form id="transaction-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Account *</label>
                    <select id="transaction-account" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        <option value="">Select account...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Category <span id="category-required-indicator">*</span></label>
                    <select id="transaction-category" class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        <option value="">Select category...</option>
                    </select>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="category-hint">Required for outflows, optional for inflows</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" id="amount-label">Amount *</label>
                    <input type="number" id="transaction-amount" step="0.01" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" placeholder="-45.67 for outflow, 2500.00 for inflow">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1" id="amount-hint">Enter positive for inflow, negative for outflow</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date *</label>
                    <input type="date" id="transaction-date" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
                    <input type="text" id="transaction-description" class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" placeholder="Optional">
                </div>
                <div class="flex gap-2 justify-end pt-4">
                    <button type="button" onclick="closeModal('transaction-modal')" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Add Transaction</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Transfer Modal -->
    <div id="transfer-modal" class="modal" onclick="if(event.target === this) closeModal('transfer-modal')">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4 dark:text-gray-100">Transfer Between Accounts</h3>
            <form id="transfer-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">From Account *</label>
                    <select id="transfer-from-account" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        <option value="">Select account...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">To Account *</label>
                    <select id="transfer-to-account" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        <option value="">Select account...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Amount *</label>
                    <input type="number" id="transfer-amount" step="0.01" min="0.01" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" placeholder="0.00">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date *</label>
                    <input type="date" id="transfer-date" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
                    <input type="text" id="transfer-description" class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" placeholder="Optional">
                </div>
                <div class="flex gap-2 justify-end pt-4">
                    <button type="button" onclick="closeModal('transfer-modal')" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Create Transfer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div id="account-modal" class="modal" onclick="if(event.target === this) closeModal('account-modal')">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4 dark:text-gray-100">Add Account</h3>
            <form id="account-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Account Name *</label>
                    <input type="text" id="account-name" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" placeholder="e.g., Checking Account">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Type *</label>
                    <select id="account-type" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        <option value="checking">Checking</option>
                        <option value="savings">Savings</option>
                        <option value="cash">Cash</option>
                        <option value="credit">Credit Card</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Starting Balance *</label>
                    <input type="number" id="account-balance" step="0.01" value="0" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" placeholder="0.00">
                </div>
                <div class="flex gap-2 justify-end pt-4">
                    <button type="button" onclick="closeModal('account-modal')" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Add Account</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="category-modal" class="modal" onclick="if(event.target === this) closeModal('category-modal')">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4 dark:text-gray-100">Add Category</h3>
            <form id="category-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Category Name *</label>
                    <input type="text" id="category-name" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" placeholder="e.g., Groceries">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Color</label>
                    <input type="hidden" id="category-color" value="#3b82f6">
                    <div class="grid grid-cols-5 gap-2">
                        <button type="button" class="color-swatch" data-color="#f97316" style="background-color: #f97316;" title="Orange - Household">
                            <span class="color-check hidden">‚úì</span>
                        </button>
                        <button type="button" class="color-swatch selected" data-color="#3b82f6" style="background-color: #3b82f6;" title="Blue - Transportation">
                            <span class="color-check">‚úì</span>
                        </button>
                        <button type="button" class="color-swatch" data-color="#10b981" style="background-color: #10b981;" title="Green - Groceries">
                            <span class="color-check hidden">‚úì</span>
                        </button>
                        <button type="button" class="color-swatch" data-color="#a855f7" style="background-color: #a855f7;" title="Purple - Entertainment">
                            <span class="color-check hidden">‚úì</span>
                        </button>
                        <button type="button" class="color-swatch" data-color="#ef4444" style="background-color: #ef4444;" title="Red - Utilities">
                            <span class="color-check hidden">‚úì</span>
                        </button>
                        <button type="button" class="color-swatch" data-color="#ec4899" style="background-color: #ec4899;" title="Pink - Health">
                            <span class="color-check hidden">‚úì</span>
                        </button>
                        <button type="button" class="color-swatch" data-color="#eab308" style="background-color: #eab308;" title="Yellow - Shopping">
                            <span class="color-check hidden">‚úì</span>
                        </button>
                        <button type="button" class="color-swatch" data-color="#6366f1" style="background-color: #6366f1;" title="Indigo - Subscriptions">
                            <span class="color-check hidden">‚úì</span>
                        </button>
                        <button type="button" class="color-swatch" data-color="#14b8a6" style="background-color: #14b8a6;" title="Teal - Savings">
                            <span class="color-check hidden">‚úì</span>
                        </button>
                        <button type="button" class="color-swatch" data-color="#6b7280" style="background-color: #6b7280;" title="Gray - Other">
                            <span class="color-check hidden">‚úì</span>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
                    <textarea id="category-description" class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" rows="2" placeholder="Optional"></textarea>
                </div>
                <div class="flex gap-2 justify-end pt-4">
                    <button type="button" onclick="closeModal('category-modal')" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Add Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Allocate Budget Modal -->
    <div id="allocation-modal" class="modal" onclick="if(event.target === this) closeModal('allocation-modal')">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4 dark:text-gray-100">Allocate Budget</h3>
            <form id="allocation-form" class="space-y-4">
                <input type="hidden" id="allocation-category-id">
                <input type="hidden" id="allocation-current-amount">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Category</label>
                    <div id="allocation-category-name" class="text-lg font-semibold text-gray-800 dark:text-gray-100"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Amount to Allocate *</label>
                    <input type="text" id="allocation-amount" required class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" placeholder="100 or +50 or -25 or *2 or /2">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Enter an amount, or use +/- to add/subtract, or */√∑ to multiply/divide the current allocation</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label>
                    <textarea id="allocation-notes" class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" rows="2" placeholder="Optional"></textarea>
                </div>
                <div class="flex gap-2 justify-end pt-4">
                    <button type="button" onclick="closeModal('allocation-modal')" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Allocate</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Categorize Transaction Modal -->
    <div id="categorize-modal" class="modal" onclick="if(event.target === this) closeModal('categorize-modal')">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4 dark:text-gray-100">Assign Category</h3>
            <form id="categorize-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Category</label>
                    <select id="categorize-category" class="w-full border border-gray-300 dark:border-gray-600 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                        <option value="">Leave uncategorized (for inflows)</option>
                    </select>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Leave blank for inflow transactions to flow into Ready to Assign</p>
                </div>
                <div class="text-sm text-gray-600 dark:text-gray-400">
                    <span id="categorize-count">0</span> transaction(s) selected
                </div>
                <div class="flex gap-2 justify-end pt-4">
                    <button type="button" onclick="closeModal('categorize-modal')" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Assign Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SortableJS for drag-and-drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.1/Sortable.min.js"></script>
    <script src="app.js"></script>
</body>
</html>
